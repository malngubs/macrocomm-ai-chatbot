<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Macrocomm Assistant</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="stylesheet" href="/static/brand-macrocomm.css" />
    <style>
      body { margin: 0; background: transparent; }
    </style>

    <script>
      /**
       * host.html bootstrapping:
       *  - Read ?api_base=... (injected by Electron main.js)
       *  - Publish window.API_BASE for the widget
       *  - Rewrite ANY relative fetch("/chat") to an absolute
       *    URL:  ${API_BASE}/chat
       */
      (function () {
        const qs = new URLSearchParams(location.search);
        const apiFromQuery = (qs.get("api_base") || "").trim();
        const base = (apiFromQuery || (window.API_BASE || "")).replace(/\/+$/, "");
        window.API_BASE = base;

        function joinUrl(base, path) {
          if (!base) return path || "";
          if (!path) return base;
          return base.replace(/\/+$/, "") + "/" + String(path).replace(/^\/+/, "");
        }

        const origFetch = window.fetch.bind(window);
        window.fetch = function patchedFetch(input, init) {
          try {
            if (typeof input === "string") {
              const hasScheme = /^[a-zA-Z]+:\/\//.test(input);
              if (!hasScheme) {
                const path = input.startsWith("/") ? input : "/" + input;
                input = joinUrl(window.API_BASE || "", path);
              }
            }
          } catch (e) {
            console.warn("[Macrocomm] fetch absolutize failed:", e);
          }
          return origFetch(input, init);
        };

        console.log("[Macrocomm] host API_BASE =", window.API_BASE);
      })();
    </script>
  </head>

  <body>
    <div id="macrocomm-root"></div>
    <!-- Load the widget AFTER API_BASE is set -->
    <script src="/static/macrocomm-widget.js" defer></script>
  </body>
</html>
